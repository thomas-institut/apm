<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Browser typesetting</title>
    <link rel="stylesheet" type="text/css" href="../../../node_modules/bootstrap/dist/css/bootstrap.css"/>
    <script type="text/javascript" src="../../../node_modules/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="../../../node_modules/bootstrap/dist/js/bootstrap.js"></script>

<style>
    div#text-container {
        width: 500px;
        background: #fffbeb;
        font-family: Times, serif;
        font-size: 30px;
        padding: 1em;
    }

    #text-container p {
        line-height: 36px;
    }
</style>
</head>
<body>
<div class="container">
<h1>Browser Typesetting</h1>
<p>The idea is to see if I can get the line number of individual words from text typeset by the browser.</p>
<div id="text-container">
</div>

    <div id="info"></div>
</div>

<script>

  function setText(container, tokens) {
    let html = tokens.map( (t, i) => {
      let styleText = ''
      if (t['weight'] === 'bold') {
        styleText += 'font-weight: bold;'
      }
      if (t['size'] !== 1) {
        styleText += `font-size: ${t['size']}em;`
      }
      return `<span class="token token-${i}" ${styleText==='' ? '' : `style="${styleText}"`}>${t.text}</span>`
    }).join(' ')
    container.html(`<p>${html}</p>`)
  }

  function getTsInfo(container, tokens) {
    let yPositions = []
    let tokensWithInfo = tokens.map( (t, i) => {
      let span = $(`.token-${i}`)
      let position = span.offset()
      let pY = position.top + span.height()
      yPositions.push(pY)
      t.x = position.left
      t.y = pY
      return t
    })

    let uniqueYPositions = yPositions.filter((v, i, a) => a.indexOf(v) === i).sort( (a,b) => { return a > b ? 1 : 0})

    return { yPositions: uniqueYPositions, tokens: tokensWithInfo, lineMap: calculateYPositionToLineMap(yPositions)}

  }

  function calculateYPositionToLineMap(yPositions, textSizeInPixels = 16) {
    let uniqueYPositions = yPositions.filter((v, i, a) => a.indexOf(v) === i).sort( (a,b) => { return a > b ? 1 : 0})
    let halfTextSize = textSizeInPixels / 2
    let currentYPosition = -1000
    let currentLine = 0
    let yPositionToLineMap = []
    for (let i = 0; i < uniqueYPositions.length; i++) {
      if (uniqueYPositions[i] > (currentYPosition + halfTextSize)) {
        currentYPosition = uniqueYPositions[i]
        currentLine++
      }
      yPositionToLineMap.push({ pY: uniqueYPositions[i], line: currentLine})
    }
    return yPositionToLineMap
  }

  function getClassList(element) {
    if (element.attr('class') === undefined) {
      return []
    }
    return element.attr("class").split(/\s+/)
  }

  function getTokenIndexFromTarget(element) {
    let tokenClasses = getClassList(element).filter ( (c) => { return c.split('-').length === 2})
    if (tokenClasses.length === 0) {
      return -1
    }
    return parseInt(tokenClasses[0].split('-')[1])
  }
   let someText = "This is text is placed in the screen by the browser. En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho que vivía un hidalgo de esos de adarga antigua rocín flaco y galgo corredor."
  let tokens = someText.split(' ').map( (w) => {return { text: w, weight: 'normal', slant: 'none', size: 1}})

  tokens[0]['weight'] = 'bold'
  tokens[3]['size'] = 1.5
  let textContainer = $('#text-container')

  setText(textContainer, tokens)
  console.log(getTsInfo(textContainer, tokens))

  $('.token').on('click', (ev) => {
    let index = getTokenIndexFromTarget($(ev.target))
    $('#info').html(`Click on token ${index}: '${tokens[index]['text']}'`)
  })

</script>
</body>
</html>